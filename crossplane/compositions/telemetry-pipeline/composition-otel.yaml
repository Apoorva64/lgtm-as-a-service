apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xtelemetrypipelines.telemetry.yourorg.io
spec:
  mode: Pipeline
  compositeTypeRef:
    apiVersion: telemetry.yourorg.io/v1alpha1
    kind: XTelemetryPipeline
  writeConnectionSecretsToNamespace: crossplane-system
  pipeline:
    - step: render
      functionRef:
        name: function-go-templating
      input:
        apiVersion: template.fn.crossplane.io/v1beta1
        kind: GoTemplate
        source: Inline
        inline:
          template: |
            apiVersion: fn.crossplane.io/v1beta1
            kind: Output
            spec:
              resources:
                - name: tempo
                  base:
                    apiVersion: helm.crossplane.io/v1beta1
                    kind: Release
                    spec:
                      providerConfigRef:
                        name: default
                      forProvider:
                        chart:
                          name: tempo
                          repository: https://grafana.github.io/helm-charts
                          version: 1.12.6
                        namespace: {{ .observed.composite.resource.spec.namespace }}
                        releaseName: tempo-{{ .observed.composite.resource.spec.tenant }}
                        values:
                          {{- $tempoOverride := default dict .observed.composite.resource.spec.overrides.tempoValues }}
                          {{- $tempoMode := "distributed" }}
                          {{- if .observed.composite.resource.spec.mode.monolithic }}
                          {{- $tempoMode = "monolithic" }}
                          {{- end }}
                          {{- $tempoS3 := dict "bucket" .observed.composite.resource.spec.storage.tempoBucketName "region" .observed.composite.resource.spec.storage.region }}
                          {{- if .observed.composite.resource.spec.storage.endpoint }}
                          {{- $tempoS3 = merge $tempoS3 (dict "endpoint" .observed.composite.resource.spec.storage.endpoint) }}
                          {{- end }}
                          {{- $tempoBase := dict "deploymentMode" $tempoMode "tempo" (dict "storage" (dict "trace" (dict "backend" "s3" "s3" $tempoS3))) }}
                          {{- $tempoValues := merge $tempoBase $tempoOverride }}
                          {{- toYaml $tempoValues | nindent 26 }}
                  readinessChecks:
                    - type: None
                - name: loki
                  base:
                    apiVersion: helm.crossplane.io/v1beta1
                    kind: Release
                    spec:
                      providerConfigRef:
                        name: default
                      forProvider:
                        chart:
                          name: loki
                          repository: https://grafana.github.io/helm-charts
                          version: 5.40.0
                        namespace: {{ .observed.composite.resource.spec.namespace }}
                        releaseName: loki-{{ .observed.composite.resource.spec.tenant }}
                        values:
                          {{- $lokiOverride := default dict .observed.composite.resource.spec.overrides.lokiValues }}
                          {{- $lokiMode := "SimpleScalable" }}
                          {{- if .observed.composite.resource.spec.mode.monolithic }}
                          {{- $lokiMode = "SingleBinary" }}
                          {{- end }}
                          {{- $lokiS3 := dict "region" .observed.composite.resource.spec.storage.region }}
                          {{- if .observed.composite.resource.spec.storage.endpoint }}
                          {{- $lokiS3 = merge $lokiS3 (dict "endpoint" .observed.composite.resource.spec.storage.endpoint) }}
                          {{- end }}
                          {{- $lokiBuckets := dict "chunks" .observed.composite.resource.spec.storage.lokiBucketName "ruler" .observed.composite.resource.spec.storage.lokiBucketName "admin" .observed.composite.resource.spec.storage.lokiBucketName }}
                          {{- $lokiBase := dict "deploymentMode" $lokiMode "loki" (dict "storage" (dict "type" "s3" "bucketNames" $lokiBuckets "s3" $lokiS3)) }}
                          {{- $lokiValues := merge $lokiBase $lokiOverride }}
                          {{- toYaml $lokiValues | nindent 26 }}
                  readinessChecks:
                    - type: None
                - name: mimir
                  base:
                    apiVersion: helm.crossplane.io/v1beta1
                    kind: Release
                    spec:
                      providerConfigRef:
                        name: default
                      forProvider:
                        chart:
                          name: mimir-distributed
                          repository: https://grafana.github.io/helm-charts
                          version: 5.3.0
                        namespace: {{ .observed.composite.resource.spec.namespace }}
                        releaseName: mimir-{{ .observed.composite.resource.spec.tenant }}
                        values:
                          {{- $mimirOverride := default dict .observed.composite.resource.spec.overrides.mimirValues }}
                          {{- $mimirMode := "distributed" }}
                          {{- if .observed.composite.resource.spec.mode.monolithic }}
                          {{- $mimirMode = "monolithic" }}
                          {{- end }}
                          {{- $mimirS3 := dict "bucket_name" .observed.composite.resource.spec.storage.mimirBucketName "region" .observed.composite.resource.spec.storage.region }}
                          {{- if .observed.composite.resource.spec.storage.endpoint }}
                          {{- $mimirS3 = merge $mimirS3 (dict "endpoint" .observed.composite.resource.spec.storage.endpoint) }}
                          {{- end }}
                          {{- $mimirBase := dict "deploymentMode" $mimirMode "mimir" (dict "storage" (dict "backend" "s3" "s3" $mimirS3)) }}
                          {{- $mimirValues := merge $mimirBase $mimirOverride }}
                          {{- toYaml $mimirValues | nindent 26 }}
                  readinessChecks:
                    - type: None
                - name: grafana
                  base:
                    apiVersion: helm.crossplane.io/v1beta1
                    kind: Release
                    spec:
                      providerConfigRef:
                        name: default
                      forProvider:
                        chart:
                          name: grafana
                          repository: https://grafana.github.io/helm-charts
                          version: 8.5.7
                        namespace: {{ .observed.composite.resource.spec.namespace }}
                        releaseName: grafana-{{ .observed.composite.resource.spec.tenant }}
                        values:
                          {{- $grafanaOverride := default dict .observed.composite.resource.spec.overrides.grafanaValues }}
                          {{- $grafanaBase := dict "adminUser" "admin" "adminPassword" "admin" "service" (dict "type" "ClusterIP") }}
                          {{- $grafanaValues := merge $grafanaBase $grafanaOverride }}
                          {{- toYaml $grafanaValues | nindent 26 }}
                  readinessChecks:
                    - type: None
                - name: otel-config
                  base:
                    apiVersion: kubernetes.crossplane.io/v1alpha2
                    kind: Object
                    spec:
                      forProvider:
                        manifest:
                          apiVersion: v1
                          kind: ConfigMap
                          metadata:
                            name: otel-collector
                            namespace: {{ .observed.composite.resource.spec.namespace }}
                          data:
                            collector.yaml: |
                              {{- if .observed.composite.resource.spec.overrides.otelCollectorConfig }}
                              {{ .observed.composite.resource.spec.overrides.otelCollectorConfig | nindent 30 }}
                              {{- else }}
                              receivers:
                                otlp:
                                  protocols:
                                    grpc:
                                      endpoint: 0.0.0.0:4317
                                    http:
                                      endpoint: 0.0.0.0:4318
                              exporters:
                                otlp/tempo:
                                  endpoint: {{ printf "tempo-%s-distributor.%s.svc.cluster.local:4317" .observed.composite.resource.spec.tenant .observed.composite.resource.spec.namespace }}
                                  tls:
                                    insecure: true
                                loki:
                                  endpoint: {{ printf "http://loki-%s.%s.svc.cluster.local:3100/loki/api/v1/push" .observed.composite.resource.spec.tenant .observed.composite.resource.spec.namespace }}
                                prometheusremotewrite:
                                  endpoint: {{ printf "http://mimir-%s-distributor.%s.svc.cluster.local:8080/api/v1/push" .observed.composite.resource.spec.tenant .observed.composite.resource.spec.namespace }}
                                  tls:
                                    insecure: true
                              service:
                                pipelines:
                                  traces:
                                    receivers: [otlp]
                                    exporters: [otlp/tempo]
                                  logs:
                                    receivers: [otlp]
                                    exporters: [loki]
                                  metrics:
                                    receivers: [otlp]
                                    exporters: [prometheusremotewrite]
                              {{- end }}
                  readinessChecks:
                    - type: None
                - name: otel-deployment
                  base:
                    apiVersion: kubernetes.crossplane.io/v1alpha2
                    kind: Object
                    spec:
                      forProvider:
                        manifest:
                          apiVersion: apps/v1
                          kind: Deployment
                          metadata:
                            name: otel-collector
                            namespace: {{ .observed.composite.resource.spec.namespace }}
                            labels:
                              app: otel-collector
                          spec:
                            replicas: 1
                            selector:
                              matchLabels:
                                app: otel-collector
                            template:
                              metadata:
                                labels:
                                  app: otel-collector
                              spec:
                                serviceAccountName: default
                                containers:
                                  - name: otel-collector
                                    image: otel/opentelemetry-collector-contrib:0.97.0
                                    args: ["--config=/etc/otelcol/collector.yaml"]
                                    ports:
                                      - name: otlp-grpc
                                        containerPort: 4317
                                      - name: otlp-http
                                        containerPort: 4318
                                    volumeMounts:
                                      - name: config
                                        mountPath: /etc/otelcol
                                volumes:
                                  - name: config
                                    configMap:
                                      name: otel-collector
                  readinessChecks:
                    - type: None
                - name: otel-service
                  base:
                    apiVersion: kubernetes.crossplane.io/v1alpha2
                    kind: Object
                    spec:
                      forProvider:
                        manifest:
                          apiVersion: v1
                          kind: Service
                          metadata:
                            name: otel-collector
                            namespace: {{ .observed.composite.resource.spec.namespace }}
                            labels:
                              app: otel-collector
                          spec:
                            type: ClusterIP
                            selector:
                              app: otel-collector
                            ports:
                              - name: otlp-grpc
                                port: 4317
                                targetPort: 4317
                              - name: otlp-http
                                port: 4318
                                targetPort: 4318
                  readinessChecks:
                    - type: None
