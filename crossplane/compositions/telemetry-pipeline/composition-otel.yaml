apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xtelemetrypipelines.telemetry.yourorg.io
spec:
  compositeTypeRef:
    apiVersion: telemetry.yourorg.io/v1alpha1
    kind: XTelemetryPipeline
  writeConnectionSecretsToNamespace: crossplane-system
  patchSets:
    - name: common-labels
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.labels
          policy:
            mergeOptions:
              keepMapValues: true
  resources:
    - name: tempo
      base:
        apiVersion: helm.crossplane.io/v1beta1
        kind: Release
        spec:
          providerConfigRef:
            name: default
          forProvider:
            chart:
              name: tempo
              repository: https://grafana.github.io/helm-charts
              version: 1.12.6
            namespace: observability
            releaseName: tempo
            values:
              deploymentMode: monolithic
              tempo:
                storage:
                  trace:
                    backend: s3
                    s3:
                      bucket: ${tempoBucket}
                      region: ${region}
                      endpoint: ${s3Endpoint}
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.namespace
        - type: FromCompositeFieldPath
          fromFieldPath: spec.tenant
          toFieldPath: spec.forProvider.releaseName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.mode.monolithic
          toFieldPath: spec.forProvider.values.deploymentMode
          transforms:
            - type: map
              map:
                "true": monolithic
                "false": distributed
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.region
          toFieldPath: spec.forProvider.values.tempo.storage.trace.s3.region
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.endpoint
          toFieldPath: spec.forProvider.values.tempo.storage.trace.s3.endpoint
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.tempoBucketName
          toFieldPath: spec.forProvider.values.tempo.storage.trace.s3.bucket
          policy:
            resolution: Optional
      policy:
        resolution: Optional
        readiness: Optional
    - name: loki
      base:
        apiVersion: helm.crossplane.io/v1beta1
        kind: Release
        spec:
          providerConfigRef:
            name: default
          forProvider:
            chart:
              name: loki
              repository: https://grafana.github.io/helm-charts
              version: 5.40.0
            namespace: observability
            releaseName: loki
            values:
              deploymentMode: SingleBinary
              loki:
                storage:
                  type: s3
                  bucketNames:
                    chunks: ${lokiBucket}
                    ruler: ${lokiBucket}
                    admin: ${lokiBucket}
                  s3:
                    region: ${region}
                    endpoint: ${s3Endpoint}
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.namespace
        - type: FromCompositeFieldPath
          fromFieldPath: spec.tenant
          toFieldPath: spec.forProvider.releaseName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.mode.monolithic
          toFieldPath: spec.forProvider.values.deploymentMode
          transforms:
            - type: map
              map:
                "true": SingleBinary
                "false": SimpleScalable
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.region
          toFieldPath: spec.forProvider.values.loki.storage.s3.region
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.endpoint
          toFieldPath: spec.forProvider.values.loki.storage.s3.endpoint
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.lokiBucketName
          toFieldPath: spec.forProvider.values.loki.storage.bucketNames.chunks
          policy:
            resolution: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.lokiBucketName
          toFieldPath: spec.forProvider.values.loki.storage.bucketNames.ruler
          policy:
            resolution: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.lokiBucketName
          toFieldPath: spec.forProvider.values.loki.storage.bucketNames.admin
          policy:
            resolution: Optional
      policy:
        resolution: Optional
        readiness: Optional
    - name: mimir
      base:
        apiVersion: helm.crossplane.io/v1beta1
        kind: Release
        spec:
          providerConfigRef:
            name: default
          forProvider:
            chart:
              name: mimir-distributed
              repository: https://grafana.github.io/helm-charts
              version: 5.3.0
            namespace: observability
            releaseName: mimir
            values:
              deploymentMode: monolithic
              mimir:
                storage:
                  backend: s3
                  s3:
                    bucket_name: ${mimirBucket}
                    region: ${region}
                    endpoint: ${s3Endpoint}
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.namespace
        - type: FromCompositeFieldPath
          fromFieldPath: spec.tenant
          toFieldPath: spec.forProvider.releaseName
        - type: FromCompositeFieldPath
          fromFieldPath: spec.mode.monolithic
          toFieldPath: spec.forProvider.values.deploymentMode
          transforms:
            - type: map
              map:
                "true": monolithic
                "false": distributed
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.region
          toFieldPath: spec.forProvider.values.mimir.storage.s3.region
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.endpoint
          toFieldPath: spec.forProvider.values.mimir.storage.s3.endpoint
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.mimirBucketName
          toFieldPath: spec.forProvider.values.mimir.storage.s3.bucket_name
          policy:
            resolution: Optional
      policy:
        resolution: Optional
        readiness: Optional
    - name: grafana
      base:
        apiVersion: helm.crossplane.io/v1beta1
        kind: Release
        spec:
          providerConfigRef:
            name: default
          forProvider:
            chart:
              name: grafana
              repository: https://grafana.github.io/helm-charts
              version: 8.5.7
            namespace: observability
            releaseName: grafana
            values:
              adminUser: admin
              adminPassword: admin
              service:
                type: ClusterIP
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.namespace
        - type: FromCompositeFieldPath
          fromFieldPath: spec.tenant
          toFieldPath: spec.forProvider.releaseName
      policy:
        resolution: Optional
        readiness: Optional
    - name: otel-config
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          forProvider:
            manifest:
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: otel-collector
                namespace: default
              data:
                collector.yaml: |
                  receivers:
                    otlp:
                      protocols:
                        grpc:
                          endpoint: 0.0.0.0:4317
                        http:
                          endpoint: 0.0.0.0:4318
                  exporters:
                    otlphttp/tempo:
                      endpoint: https://tempo.example.com
                      headers:
                        Authorization: ""
                    loki:
                      endpoint: https://loki.example.com/loki/api/v1/push
                      headers:
                        X-Scope-OrgID: "tenant"
                    prometheusremotewrite:
                      endpoint: https://mimir.example.com/api/v1/push
                  service:
                    pipelines:
                      traces:
                        receivers: [otlp]
                        exporters: [otlphttp/tempo]
                      logs:
                        receivers: [otlp]
                        exporters: [loki]
                      metrics:
                        receivers: [otlp]
                        exporters: [prometheusremotewrite]
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.manifest.metadata.namespace
        - type: CombineFromComposite
          toFieldPath: spec.forProvider.manifest.data.collector.yaml
          policy:
            fromFieldPath: Optional
          combine:
            variables:
              - fromFieldPath: spec.exporters.tempoEndpoint
              - fromFieldPath: spec.auth.tempoHeader
              - fromFieldPath: spec.exporters.lokiEndpoint
              - fromFieldPath: spec.auth.lokiTenant
              - fromFieldPath: spec.auth.lokiHeader
              - fromFieldPath: spec.exporters.mimirEndpoint
              - fromFieldPath: spec.auth.mimirHeader
            strategy: string
            string:
              fmt: |
                receivers:
                  otlp:
                    protocols:
                      grpc:
                        endpoint: 0.0.0.0:4317
                      http:
                        endpoint: 0.0.0.0:4318
                exporters:
                  otlphttp/tempo:
                    endpoint: %s
                    headers:
                      Authorization: "%s"
                  loki:
                    endpoint: %s
                    headers:
                      X-Scope-OrgID: "%s"
                      Authorization: "%s"
                  prometheusremotewrite:
                    endpoint: %s
                    headers:
                      Authorization: "%s"
                service:
                  pipelines:
                    traces:
                      receivers: [otlp]
                      exporters: [otlphttp/tempo]
                    logs:
                      receivers: [otlp]
                      exporters: [loki]
                    metrics:
                      receivers: [otlp]
                      exporters: [prometheusremotewrite]
    - name: otel-deployment
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          forProvider:
            manifest:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: otel-collector
                namespace: default
                labels:
                  app: otel-collector
              spec:
                replicas: 1
                selector:
                  matchLabels:
                    app: otel-collector
                template:
                  metadata:
                    labels:
                      app: otel-collector
                  spec:
                    serviceAccountName: default
                    containers:
                      - name: otel-collector
                        image: otel/opentelemetry-collector-contrib:0.97.0
                        args: ["--config=/etc/otelcol/collector.yaml"]
                        ports:
                          - name: otlp-grpc
                            containerPort: 4317
                          - name: otlp-http
                            containerPort: 4318
                        volumeMounts:
                          - name: config
                            mountPath: /etc/otelcol
                    volumes:
                      - name: config
                        configMap:
                          name: otel-collector
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.manifest.metadata.namespace
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.manifest.spec.template.metadata.namespace
          policy:
            fromFieldPath: Optional
    - name: otel-service
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          forProvider:
            manifest:
              apiVersion: v1
              kind: Service
              metadata:
                name: otel-collector
                namespace: default
                labels:
                  app: otel-collector
              spec:
                type: ClusterIP
                selector:
                  app: otel-collector
                ports:
                  - name: otlp-grpc
                    port: 4317
                    targetPort: 4317
                  - name: otlp-http
                    port: 4318
                    targetPort: 4318
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.manifest.metadata.namespace
    - name: ingress
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          deletionPolicy: Orphan
          forProvider:
            manifest:
              apiVersion: networking.k8s.io/v1
              kind: Ingress
              metadata:
                name: otel-collector
                namespace: default
              spec:
                rules: []
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.namespace
          toFieldPath: spec.forProvider.manifest.metadata.namespace
        - type: CombineFromComposite
          policy:
            fromFieldPath: Optional
          combine:
            variables:
              - fromFieldPath: spec.ingress.public
              - fromFieldPath: spec.ingress.host
            strategy: string
            string:
              fmt: "%t|%s"
          toFieldPath: spec.forProvider.manifest.spec.rules
          transforms:
            - type: map
              map:
                "true|": []
                "false|": []
      policy:
        resolution: Optional
        readiness: Optional
    - name: tempo-bucket
      base:
        apiVersion: s3.aws.upbound.io/v1beta1
        kind: Bucket
        spec:
          deletionPolicy: Orphan
          forProvider:
            region: us-east-1
            acl: private
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.region
          toFieldPath: spec.forProvider.region
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.tempoBucketName
          toFieldPath: metadata.name
          policy:
            resolution: Required
    - name: loki-bucket
      base:
        apiVersion: s3.aws.upbound.io/v1beta1
        kind: Bucket
        spec:
          deletionPolicy: Orphan
          forProvider:
            region: us-east-1
            acl: private
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.region
          toFieldPath: spec.forProvider.region
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.lokiBucketName
          toFieldPath: metadata.name
          policy:
            resolution: Optional
    - name: mimir-bucket
      base:
        apiVersion: s3.aws.upbound.io/v1beta1
        kind: Bucket
        spec:
          deletionPolicy: Orphan
          forProvider:
            region: us-east-1
            acl: private
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.region
          toFieldPath: spec.forProvider.region
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storage.mimirBucketName
          toFieldPath: metadata.name
          policy:
            resolution: Optional
  connectionDetails:
    - type: FromValue
      name: endpoint
      value: otel-collector
    - type: FromValue
      name: grpcPort
      value: "4317"
    - type: FromValue
      name: httpPort
      value: "4318"
